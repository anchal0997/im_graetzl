<% meta(
    title: t('.title'),
    description: t('.description'),
    robots: 'noindex, nofollow',
  )
%>

<style>

</style>
<section class="reports">

  <% if user_signed_in? && current_user.admin? %>
  <!-- ADMIN REPORT INTERFACE -->
    <script>
    (function () {
    // --------------- BEGIN PROJECT JS WORKING AREA ---------------

      // Init Vars
      moment.locale('de-at');

      // TimeTable Object for Charts - Including Unit & Date Range
      var timePeriod = {
        unit:'',
        dates:[],
        datesFriendly:[]
      };
      // Time Period Data for Charts
      var timePeriodData = [];

      var users = []; // Clean Users Array to work with
      var graetzls = []; // Clean Grätzl Array to work with
      var locations = []; // Clean Location Array to work with
      var host = 'http://' + window.location.host + '/'; // Environment Path
      var host_admin = 'http://' + window.location.host + '/admin/'; // Active Admin Path




      $( document ).ready(function() {

        // Load Data from Server - if all Data loaded, do something ...
        var p1 = requestUsers();
        var p2 = requestGraetzls();
        var p3 = requestLocations();

        Promise.all([p1, p2, p3]).then(function(res) {

          extend_arrays_each_other();
          datatable_users();
          datatable_graetzls();
          charts();

        })//.catch( function() {alert('Error Loading Data ...'); } )

      });



      // -------------- Helper Functions --------------

      // Get Infos from other Array over ID
      var fetchFromID = function(id, type){
        if ( type == 'graetzls' ) {
          var result = graetzls.filter(function(e){ return e.id == id; });
          return result;
        }
        if ( type == 'locations' ) {
          var result = locations.filter(function(e){ return e.user_ids == id; });
          return result;
        }
      }


    // ------------- Data Table - User Detail Row --------
    /* Formatting function for row details - modify as you need */
      function userDetails ( data ) {

        var $content = $('<table id="user' + data.id + '">');
        $($content).append('<tr><td>' + data.first_name + ' ' + data.last_name + '</td></tr>');

        // Get User Locations
        var locationinfos = fetchFromID(data.id, 'locations');
        for ( i=0; i<locationinfos.length; i++) {
          $($content).append('<tr><td>Location: <a href="'+locationinfos[i].location_path_admin+'">' +locationinfos[i].name+ '</td></tr>');
        }

        return $content;
      }


      // -------------- Ajax JSON Requests --------------

      // Get Users and Set Clean User Array



      var requestUsers = function(){
        return new Promise( function(resolve, reject) {
          $.ajax( {
            url:'/admin/users.json',
            method:'GET',
            success:function(response) {

              for( i=0; i < response.length; i++ ) {
                users.push({
                  id: response[i].id,
                  graetzl_id: response[i].graetzl_id,
                  graetzl_name: '',
                  graetzl_path: '',
                  created_at: new Date(response[i].created_at),
                  username: response[i].username,
                  first_name: response[i].first_name,
                  last_name: response[i].last_name,
                  email: response[i].email,
                  user_path_admin: host_admin + 'users/' + response[i].slug,
                  user_path: host + response[i].slug
                })
              }
              resolve('users');
            }
          });
        });
      } // Get Users

      // Get Grätzls and Set Clean Grätzl Array
      var requestGraetzls = function(){
        return new Promise( function(resolve, reject) {
          $.ajax( {
            url:'/admin/graetzls.json',
            method:'GET',
            success:function(response) {
              for( i=0; i < response.length; i++ ) {
                graetzls.push({
                  id: response[i].id,
                  name: response[i].name,
                  graetzl_path: host + response[i].slug,
                  graetzl_path_admin: host_admin + 'graetzls/' + response[i].slug,
                  users_count: response[i].users_count
                });
              }
              resolve('graetzls');
            }
          });
        });
      } // Get Grätzls

      // Get Locations and Set Clean Location Array
      var requestLocations = function(){
        return new Promise( function(resolve, reject) {
          $.ajax( {
            url:'/admin/locations.json',
            method:'GET',
            success:function(response) {
              for( i=0; i < response.length; i++ ) {
                //console.log(response[i]);
                locations.push({
                  id: response[i].id,
                  name: response[i].name,
                  created_at: response[i].created_at,
                  graetzl_id: response[i].graetzl_id,
                  graetzl_name: '',
                  category_id: response[i].category_id,
                  state: response[i].state,
                  user_ids: response[i].user_ids,
                  location_path: response[i].slug,
                  location_path_admin: host_admin + 'locations/' + response[i].slug
                })
              }
              resolve('locations');
            }
          });
        });
      } // Get Locations

      // -------------- Create Datatables (jQuery Plugin) --------------

      // Create DATATABLE Users
      var datatable_users = function() {
        $('#datatable_users').DataTable( {
          data: users,
          "order": [[ 0, "desc" ]],
          "processing": true,
          "scrollY": "400px",
          "scrollCollapse": true,
          "paging": false,
          columns: [
            {
              "className": 'details-control',
              "orderable": false,
              "data": null,
              "defaultContent": 'details'
            },
            { data: 'id' },
            { data: 'username',
              render: function( data, type, row, meta ){
                if ( type === 'display' ) {
                data = '<a href="' + row['user_path_admin'] + '">' + data + '</a>';
              }
                return data;
              }
            },
            { data: 'email' },
            { data: 'graetzl_name',
              render: function( data, type, row, meta ){
                if ( type === 'display' ) {
                data = '<a href="' + row['graetzl_path'] + '">' + data + '</a>';
              }
                return data;
              }
            },
            { data: 'created_at',
              render: function(data, type) {
                if ( type == "sort" || type == 'type' ) {
                  return data;
                } else {
                  // Use Friendly Format for Output
                  return moment(data).format('lll');
                }
              }
            }
          ]
        });
      }

      // Create DATATABLE Grätzl
      var datatable_graetzls = function() {
        $('#datatable_graetzls').DataTable( {
          data: graetzls,
          "order": [[ 1, "desc" ]],
          "processing": true,
          "scrollY": "400px",
          "scrollCollapse": true,
          "paging": false,
          columns: [
            { data: 'name'},
            { data: 'users_count' }
          ]
        });
      }

      // -------------- Event Listener --------------
      $(document).ready(function() {

        // Add event listener for opening and closing detail rows
        $('#datatable_users').on('click', 'td.details-control', function () {
          var table = $('#datatable_users').DataTable();
          var tr = $(this).closest('tr');
          var row = table.row( tr );

          if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
          }
          else {
            // Open this row
            row.child( userDetails(row.data()) ).show();
            tr.addClass('shown');
          }
        }); // Expand User Row

        // Charts
        var chart = $("#chart");


      });


      // Test with Charts ....
      var charts = function(){
        createDateChartValues('users', 30, 'days');
      };


      var extend_arrays_each_other = function() {

        // Extend Location Array with Grätzl-Infos
        for( i=0; i<locations.length; i++ ) {
          var graetzlinfos = fetchFromID(locations[i].graetzl_id, 'graetzls');
          for (let key in graetzlinfos) {
            //console.log(graetzlinfos[key]);
            locations[i].graetzl_name = graetzlinfos[key].name;
            locations[i].location_path = graetzlinfos[key].graetzl_path;
          }
        }

        // Extend User Array with Grätzl-Indos
        for( i=0; i<users.length; i++ ) {
          graetzlinfos = fetchFromID(users[i].graetzl_id, 'graetzls');
          for (let key in graetzlinfos) {
            //console.log(graetzlinfos[key]);
            users[i].graetzl_name = graetzlinfos[key].name;
            users[i].graetzl_path = graetzlinfos[key].graetzl_path;
          }
        }

        console.log(users);
        console.log(locations);
      };




      // Create Chart Arrays
      var createDateChartValues = function( type, count, unit ) {

        // Set Length of Data Array to Count
        timePeriodData.length = count;
        timePeriodData.fill(0); // Prefill all Values with 0

        // Fill Time Period Array with Dates for Chart-View
        var generateTimePeriod = function( count, unit ) {
          timePeriod.unit = unit;
          var currentDate = new Date(); // Today
          if (unit == 'days') {
            for ( i=0; i<count; i++ ) {

              var tmpDate = new Date();
              tmpDate.setDate(currentDate.getDate() - i);
              tmpDate.setHours(0,0,0,0);
              var priorDate = new Date(tmpDate);
              var priorDateFriendly = moment(priorDate).format('ll');

              //console.log(priorDateFriendly);
              timePeriod.dates.push(priorDate);
              timePeriod.datesFriendly.push(priorDateFriendly);
            }
          }
        } // Time Period Array
        generateTimePeriod(count, unit); // Set Time Period


        // Loop Check all Users
        for ( i=0; i<users.length; i++) {
          var checkDate = new Date(users[i].created_at);

          // Loop Check every single User for all Dates in Range
          for ( d=0; d<timePeriod.dates.length; d++ ) {

            var check = checkDateRange( checkDate, timePeriod.dates[d], unit );
            if (check == true) {

              //console.log('user gefunden: ' + users[i].id + ' date: ' + timePeriod.dates[d] + ' pos: ' + d);
              // Push Sum of found Data Goals to Data Array on right Index-Postion
              timePeriodData[d] +=1;
              break;

            }
          } // Loop Check every single User for all Dates
        } // Loop Check all Users


        // Draw User Chart
        usersChart(timePeriod.datesFriendly.reverse(), timePeriodData.reverse());

      } // Create Chart Arrays


      // Helper Function - Check if Date is in Date-Range
      var checkDateRange = function( checkDate, startDate, unit ) {
        var tmpDate = new Date();
        tmpDate.setDate(startDate.getDate() + 1);
        tmpDate.setHours(0,0,0,0);
        var endDate = new Date(tmpDate);
        if (checkDate >= startDate && checkDate <= endDate ){
          return true;
        }
      }



      var usersChart = function(labeldata, chartdata) {
        new Chart(chart, {
          type: 'line',
          data: {
            labels: labeldata,
            datasets: [{
              label: 'Registrierungen',
              data: chartdata,
            }]
          }
        });
      }



    // --------------- END WORK JS WORKING AREA ---------------
    })();
    </script>


    <canvas id="chart" width="900" height="200"></canvas>


    <table id="datatable_users" class="stripe hover row-border" width="100%">
      <thead>
        <tr>
          <th></th>
          <th>ID</th>
          <th>Username</th>
          <th>E-Mail</th>
          <th>Grätzl</th>
          <th>Registriert</th>
        </tr>
      </thead>
    </table>



    <table id="datatable_graetzls" class="stripe hover row-border" width="100%">
      <thead>
        <tr>
          <th>Grätzl</th>
          <th>Anzahl User</th>
        </tr>
      </thead>
    </table>


  <!-- // ADMIN REPORT INTERFACE -->

  <% else %>
  <!-- NO ADMIN RIGHTS -->
    Keine Admin Rechte ...
  <% end %>

</section>
